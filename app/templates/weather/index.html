{% extends "win98_window.html" %}

{% block title %}Weather{% endblock %}
{% block window_title %}Weather - The Weather Channel{% endblock %}
{% block taskbar_title %}Weather{% endblock %}

{% set window_icon = 'weather.svg' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/weather.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Win98 Weather Overrides */
.weather-dashboard {
    background: var(--win98-gray);
    padding: 8px;
    min-height: 400px;
}

.weather-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 8px;
    border-bottom: none;
}

.tab-btn {
    padding: 4px 12px;
    background: var(--win98-gray);
    border: 2px solid;
    border-color: var(--win98-btn-highlight) var(--win98-btn-dark-shadow) var(--win98-btn-dark-shadow) var(--win98-btn-highlight);
    font-family: var(--win98-font);
    font-size: 11px;
    cursor: pointer;
    position: relative;
    bottom: -2px;
}

.tab-btn.active {
    border-bottom-color: var(--win98-gray);
    z-index: 1;
}

.tab-btn i {
    margin-right: 4px;
}

.tab-content {
    display: none;
    background: white;
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    padding: 8px;
}

.tab-content.active {
    display: block;
}

.location-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 4px;
    background: var(--win98-gray);
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
}

.location-current {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: bold;
}

.location-search {
    flex: 1;
    display: flex;
    position: relative;
}

.location-search input {
    flex: 1;
    padding: 2px 4px;
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    font-family: var(--win98-font);
    font-size: 11px;
}

.location-search button, .geo-btn {
    padding: 2px 8px;
    background: var(--win98-gray);
    border: 2px solid;
    border-color: var(--win98-btn-highlight) var(--win98-btn-dark-shadow) var(--win98-btn-dark-shadow) var(--win98-btn-highlight);
    font-family: var(--win98-font);
    font-size: 11px;
    cursor: pointer;
}

.location-search button:active, .geo-btn:active {
    border-color: var(--win98-btn-dark-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-dark-shadow);
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    z-index: 100;
    display: none;
    max-height: 200px;
    overflow-y: auto;
}

.search-item {
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
}

.search-item:hover {
    background: var(--win98-title-blue);
    color: white;
}

.current-weather-card {
    background: white;
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    padding: 12px;
    margin-bottom: 12px;
}

.weather-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 20px;
    font-size: 11px;
}

.weather-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.weather-main {
    display: flex;
    align-items: center;
    gap: 16px;
}

.weather-icon-large {
    font-size: 48px;
    color: #f59e0b;
}

.weather-icon-large.sunny { color: #f59e0b; }
.weather-icon-large.cloudy { color: #6b7280; }
.weather-icon-large.rainy { color: #3b82f6; }
.weather-icon-large.stormy { color: #1f2937; }
.weather-icon-large.snowy { color: #60a5fa; }
.weather-icon-large.foggy { color: #9ca3af; }

.weather-temp {
    display: flex;
    align-items: flex-start;
}

.temp-value {
    font-size: 48px;
    font-weight: bold;
    line-height: 1;
}

.temp-unit {
    font-size: 18px;
    margin-top: 8px;
}

.weather-condition {
    font-size: 14px;
    font-weight: bold;
}

.weather-details {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.detail-item {
    background: var(--win98-gray);
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    padding: 8px;
    text-align: center;
}

.detail-item i {
    display: block;
    font-size: 16px;
    margin-bottom: 4px;
    color: var(--win98-title-blue);
}

.detail-label {
    display: block;
    font-size: 10px;
    color: #666;
}

.detail-value {
    display: block;
    font-size: 12px;
    font-weight: bold;
}

.forecast-section {
    background: white;
    border: 2px solid;
    border-color: var(--win98-btn-shadow) var(--win98-btn-highlight) var(--win98-btn-highlight) var(--win98-btn-shadow);
    padding: 12px;
}

.forecast-section h3 {
    font-size: 12px;
    margin: 0 0 8px 0;
    padding-bottom: 4px;
    border-bottom: 1px solid #ccc;
}

.forecast-section h3 i {
    margin-right: 4px;
}

.forecast-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.forecast-day {
    text-align: center;
    padding: 8px 4px;
    background: var(--win98-gray);
    border: 1px solid;
    border-color: var(--win98-btn-highlight) var(--win98-btn-shadow) var(--win98-btn-shadow) var(--win98-btn-highlight);
}

.forecast-day-name {
    font-size: 10px;
    font-weight: bold;
    margin-bottom: 4px;
}

.forecast-icon {
    font-size: 20px;
    margin: 4px 0;
}

.forecast-temps {
    font-size: 11px;
}

.temp-high {
    font-weight: bold;
}

.temp-low {
    color: #666;
    margin-left: 4px;
}

.forecast-precip {
    font-size: 9px;
    color: #3b82f6;
    margin-top: 4px;
}

.coming-soon-placeholder {
    text-align: center;
    padding: 40px;
    color: #808080;
}

.coming-soon-placeholder i {
    font-size: 32px;
    margin-bottom: 8px;
}

.coming-soon-placeholder h3 {
    font-size: 14px;
    margin: 8px 0;
}

.coming-soon-placeholder p {
    font-size: 11px;
}

@media (max-width: 640px) {
    .weather-details {
        grid-template-columns: repeat(2, 1fr);
    }
    .forecast-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    .forecast-day:nth-child(n+5) {
        display: none;
    }
}
</style>
{% endblock %}

{% block menu_bar %}
<div class="win98-menu-bar">
    <span class="win98-menu-item">File</span>
    <span class="win98-menu-item">View</span>
    <span class="win98-menu-item">Options</span>
    <span class="win98-menu-item">Help</span>
</div>
{% endblock %}

{% block window_content %}
<div class="weather-dashboard" id="weatherDashboard">
    <div class="weather-tabs">
        <button class="tab-btn active" data-tab="current">
            <i class="fas fa-cloud-sun"></i>
            Current Weather
        </button>
        <button class="tab-btn" data-tab="coming-soon">
            <i class="fas fa-chart-line"></i>
            Coming Soon
        </button>
    </div>

    <section id="current-tab" class="tab-content active">
        <div class="location-bar">
            <div class="location-current" id="currentLocation">
                <i class="fas fa-location-dot"></i>
                <span id="locationName">Detecting location...</span>
            </div>
            <div class="location-search">
                <input type="text" id="citySearch" placeholder="Search city..." autocomplete="off">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
                <div class="search-results" id="searchResults"></div>
            </div>
            <button id="geolocateBtn" class="geo-btn" title="Use my location">
                <i class="fas fa-crosshairs"></i>
            </button>
        </div>

        <div class="current-weather-card" id="currentWeatherCard">
            <div class="weather-loading" id="currentLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading weather...</span>
            </div>
            <div class="weather-content" id="currentContent" style="display: none;">
                <div class="weather-main">
                    <div class="weather-icon-large" id="weatherIconLarge">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="weather-temp">
                        <span class="temp-value" id="tempValue">--</span>
                        <span class="temp-unit">°C</span>
                    </div>
                    <div class="weather-condition" id="weatherCondition">--</div>
                </div>
                <div class="weather-details">
                    <div class="detail-item">
                        <i class="fas fa-temperature-half"></i>
                        <span class="detail-label">Feels Like</span>
                        <span class="detail-value" id="feelsLike">--°C</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-droplet"></i>
                        <span class="detail-label">Humidity</span>
                        <span class="detail-value" id="humidity">--%</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-wind"></i>
                        <span class="detail-label">Wind</span>
                        <span class="detail-value" id="windSpeed">-- km/h</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-cloud-rain"></i>
                        <span class="detail-label">Precipitation</span>
                        <span class="detail-value" id="precipitation">-- mm</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="forecast-section">
            <h3><i class="fas fa-calendar-days"></i> 7-Day Forecast</h3>
            <div class="forecast-grid" id="forecastGrid">
                <div class="weather-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>
    </section>

    <section id="coming-soon-tab" class="tab-content">
        <div class="coming-soon-placeholder">
            <i class="fas fa-hammer"></i>
            <h3>Feature Coming Soon</h3>
            <p>We're working on something new for this space.</p>
        </div>
    </section>
</div>
{% endblock %}

{% block status_bar %}
<div class="win98-status-bar">
    <span class="win98-status-section" style="flex: 1;">Ready</span>
    <span class="win98-status-section">Open-Meteo API</span>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/weather-engine.js') }}"></script>
<script>
(function() {
    'use strict';

    let currentLat = null;
    let currentLon = null;
    let currentWeatherTheme = 'sunny';

    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const locationName = document.getElementById('locationName');
    const citySearch = document.getElementById('citySearch');
    const searchBtn = document.getElementById('searchBtn');
    const geolocateBtn = document.getElementById('geolocateBtn');
    const searchResults = document.getElementById('searchResults');
    const currentLoading = document.getElementById('currentLoading');
    const currentContent = document.getElementById('currentContent');
    const tempValue = document.getElementById('tempValue');
    const weatherCondition = document.getElementById('weatherCondition');
    const weatherIconLarge = document.getElementById('weatherIconLarge');
    const feelsLike = document.getElementById('feelsLike');
    const humidity = document.getElementById('humidity');
    const windSpeed = document.getElementById('windSpeed');
    const precipitation = document.getElementById('precipitation');
    const forecastGrid = document.getElementById('forecastGrid');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        });
    });

    function updateWeatherBackground(theme) {
        if (currentWeatherTheme === theme) return;
        currentWeatherTheme = theme;
        window.dispatchEvent(new CustomEvent('weatherchange', { detail: { theme } }));
    }

    function renderForecastDay(day, isToday) {
        const date = new Date(day.date);
        const dayName = isToday ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
        const div = document.createElement('div');
        div.className = 'forecast-day';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'forecast-day-name';
        nameDiv.textContent = dayName;
        div.appendChild(nameDiv);

        const iconDiv = document.createElement('div');
        iconDiv.className = 'forecast-icon';
        const icon = document.createElement('i');
        icon.className = 'fas fa-' + day.weather_icon;
        iconDiv.appendChild(icon);
        div.appendChild(iconDiv);

        const tempsDiv = document.createElement('div');
        tempsDiv.className = 'forecast-temps';
        const highSpan = document.createElement('span');
        highSpan.className = 'temp-high';
        highSpan.textContent = Math.round(day.temp_max) + '°';
        const lowSpan = document.createElement('span');
        lowSpan.className = 'temp-low';
        lowSpan.textContent = Math.round(day.temp_min) + '°';
        tempsDiv.appendChild(highSpan);
        tempsDiv.appendChild(lowSpan);
        div.appendChild(tempsDiv);

        if (day.precipitation_probability) {
            const precipDiv = document.createElement('div');
            precipDiv.className = 'forecast-precip';
            const dropIcon = document.createElement('i');
            dropIcon.className = 'fas fa-droplet';
            precipDiv.appendChild(dropIcon);
            precipDiv.appendChild(document.createTextNode(' ' + day.precipitation_probability + '%'));
            div.appendChild(precipDiv);
        }

        return div;
    }

    async function loadCurrentWeather(lat, lon, cityName) {
        currentLoading.style.display = 'flex';
        currentContent.style.display = 'none';

        try {
            const response = await fetch('/projects/weather/api/current?lat=' + lat + '&lon=' + lon);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            tempValue.textContent = Math.round(data.temperature);
            weatherCondition.textContent = data.weather_text;
            weatherIconLarge.className = 'weather-icon-large ' + data.weather_theme;
            weatherIconLarge.textContent = '';
            const iconEl = document.createElement('i');
            iconEl.className = 'fas fa-' + data.weather_icon;
            weatherIconLarge.appendChild(iconEl);

            feelsLike.textContent = Math.round(data.feels_like) + '°C';
            humidity.textContent = data.humidity + '%';
            windSpeed.textContent = Math.round(data.wind_speed) + ' km/h';
            precipitation.textContent = data.precipitation + ' mm';

            if (cityName) locationName.textContent = cityName;

            updateWeatherBackground(data.weather_theme);

            currentLoading.style.display = 'none';
            currentContent.style.display = 'block';

            loadForecast(lat, lon);

        } catch (error) {
            console.error('Error loading weather:', error);
            currentLoading.textContent = '';
            const errIcon = document.createElement('i');
            errIcon.className = 'fas fa-exclamation-triangle';
            currentLoading.appendChild(errIcon);
            const errSpan = document.createElement('span');
            errSpan.textContent = 'Failed to load weather';
            currentLoading.appendChild(errSpan);
        }
    }

    async function loadForecast(lat, lon) {
        try {
            const response = await fetch('/projects/weather/api/forecast?lat=' + lat + '&lon=' + lon);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            forecastGrid.textContent = '';
            data.days.forEach((day, i) => {
                forecastGrid.appendChild(renderForecastDay(day, i === 0));
            });

        } catch (error) {
            console.error('Error loading forecast:', error);
            forecastGrid.textContent = '';
            const errDiv = document.createElement('div');
            errDiv.className = 'error';
            errDiv.textContent = 'Failed to load forecast';
            forecastGrid.appendChild(errDiv);
        }
    }

    function renderSearchResult(city) {
        const fullName = [city.name, city.admin1, city.country].filter(Boolean).join(', ');
        const div = document.createElement('div');
        div.className = 'search-item';
        div.dataset.lat = city.lat;
        div.dataset.lon = city.lon;
        div.dataset.name = fullName;

        const icon = document.createElement('i');
        icon.className = 'fas fa-location-dot';
        div.appendChild(icon);

        const span = document.createElement('span');
        span.textContent = fullName;
        div.appendChild(span);

        return div;
    }

    async function searchCity(query) {
        if (!query.trim()) {
            searchResults.style.display = 'none';
            return;
        }

        try {
            const response = await fetch('/projects/weather/api/geocode?city=' + encodeURIComponent(query));
            const data = await response.json();

            searchResults.textContent = '';

            if (data.error || !data.results || data.results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'search-item no-results';
                noResults.textContent = 'No cities found';
                searchResults.appendChild(noResults);
            } else {
                data.results.forEach(city => {
                    searchResults.appendChild(renderSearchResult(city));
                });
            }

            searchResults.style.display = 'block';

        } catch (error) {
            console.error('Error searching city:', error);
        }
    }

    searchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-item');
        if (item && item.dataset.lat) {
            const lat = parseFloat(item.dataset.lat);
            const lon = parseFloat(item.dataset.lon);
            const name = item.dataset.name;

            currentLat = lat;
            currentLon = lon;

            localStorage.setItem('weather_last_city', JSON.stringify({ lat, lon, name }));

            searchResults.style.display = 'none';
            citySearch.value = '';
            loadCurrentWeather(lat, lon, name);
        }
    });

    let searchTimeout;
    citySearch.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchCity(e.target.value), 300);
    });

    citySearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchCity(citySearch.value);
    });

    searchBtn.addEventListener('click', () => searchCity(citySearch.value));

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.location-search') && !e.target.closest('.search-results')) {
            searchResults.style.display = 'none';
        }
    });

    function getGeolocation() {
        locationName.textContent = 'Detecting location...';

        if (!navigator.geolocation) {
            locationName.textContent = 'Geolocation not supported';
            loadFromSaved();
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                currentLat = position.coords.latitude;
                currentLon = position.coords.longitude;

                try {
                    const response = await fetch('/projects/weather/api/geocode?city=' + currentLat + ',' + currentLon);
                    const data = await response.json();
                    const cityName = data.results && data.results[0] ? data.results[0].name : 'Your Location';
                    loadCurrentWeather(currentLat, currentLon, cityName);
                } catch {
                    loadCurrentWeather(currentLat, currentLon, 'Your Location');
                }
            },
            (error) => {
                console.log('Geolocation error:', error);
                loadFromSaved();
            },
            { timeout: 10000 }
        );
    }

    function loadFromSaved() {
        const saved = localStorage.getItem('weather_last_city');
        if (saved) {
            try {
                const { lat, lon, name } = JSON.parse(saved);
                currentLat = lat;
                currentLon = lon;
                loadCurrentWeather(lat, lon, name);
                return;
            } catch {}
        }

        currentLat = 40.7128;
        currentLon = -74.0060;
        loadCurrentWeather(currentLat, currentLon, 'New York, USA');
    }

    geolocateBtn.addEventListener('click', getGeolocation);
    getGeolocation();
})();
</script>
{% endblock %}
